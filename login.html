<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µìˆ˜ë‹¬ë ¥ - ë¡œê·¸ì¸</title>
    <link rel="stylesheet" href="./css/style.css">
    <style>
        /* ë¡œê·¸ì¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .login-header p {
            color: #666;
            font-size: 16px;
            margin: 0;
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 4px;
        }
        
        .login-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }
        
        .login-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .divider {
            margin: 30px 0;
            position: relative;
            text-align: center;
            color: #666;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e9ecef;
        }
        
        .divider span {
            background: white;
            padding: 0 20px;
        }
        
        .guest-login {
            padding: 14px;
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .guest-login:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .migration-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: left;
        }
        
        .migration-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .migration-section p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .migration-button {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .migration-button:hover {
            background: #218838;
        }
        
        .migration-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        @media (max-width: 480px) {
            .login-card {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .login-header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>ğŸ—“ï¸ ê³µìˆ˜ë‹¬ë ¥</h1>
                <p>í´ë¼ìš°ë“œ ë™ê¸°í™”ë¡œ ì–´ë””ì„œë‚˜ ì ‘ê·¼í•˜ì„¸ìš”</p>
            </div>
            
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchTab('signin')">ë¡œê·¸ì¸</button>
                <button class="login-tab" onclick="switchTab('signup')">íšŒì›ê°€ì…</button>
            </div>
            
            <!-- ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ -->
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>
            
            <!-- ë¡œê·¸ì¸ í¼ -->
            <form id="signinForm" class="login-form active">
                <div class="form-group">
                    <label for="signinEmail">ì´ë©”ì¼</label>
                    <input type="email" id="signinEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="signinPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="signinPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button type="submit" class="login-button" id="signinButton">
                    ë¡œê·¸ì¸
                </button>
            </form>
            
            <!-- íšŒì›ê°€ì… í¼ -->
            <form id="signupForm" class="login-form">
                <div class="form-group">
                    <label for="signupEmail">ì´ë©”ì¼</label>
                    <input type="email" id="signupEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="signupPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="signupPassword" required placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”" minlength="6">
                </div>
                <div class="form-group">
                    <label for="signupPasswordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="signupPasswordConfirm" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" minlength="6">
                </div>
                <button type="submit" class="login-button" id="signupButton">
                    íšŒì›ê°€ì…
                </button>
            </form>
            
            <!-- êµ¬ë¶„ì„  -->
            <div class="divider">
                <span>ë˜ëŠ”</span>
            </div>
            
            <!-- ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ -->
            <button class="guest-login" onclick="continueAsGuest()">
                ğŸš€ ê²ŒìŠ¤íŠ¸ë¡œ ê³„ì†í•˜ê¸° (ë¡œì»¬ ì €ì¥)
            </button>
            
            <!-- ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¹ì…˜ -->
            <div class="migration-section" id="migrationSection" style="display: none;">
                <h3>ğŸ“¦ ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h3>
                <p>ë¡œì»¬ì— ì €ì¥ëœ ê¸°ì¡´ ê³µìˆ˜ ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œë¡œ ì´ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <button class="migration-button" id="migrationButton" onclick="migrateData()">
                    ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
                </button>
            </div>
        </div>
    </div>
    
    <!-- Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase í´ë¼ì´ì–¸íŠ¸ -->
    <script src="./js/supabase-client.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let isLoading = false;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase ì—°ê²° ìƒíƒœ í™•ì¸
            if (!window.SupabaseClient.isSupabaseConnected()) {
                showError('Supabase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                return;
            }
            
            // ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸
            checkExistingSession();
            
            // ê¸°ì¡´ localStorage ë°ì´í„° í™•ì¸
            checkLocalStorageData();
        });
        
        // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
        async function checkExistingSession() {
            try {
                const { data } = await window.SupabaseClient.getCurrentUser();
                if (data.user) {
                    // ì´ë¯¸ ë¡œê·¸ì¸ëœ ê²½ìš° ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.log('ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° í™•ì¸
        function checkLocalStorageData() {
            const localData = localStorage.getItem('gongsooCalendarData');
            if (localData) {
                try {
                    const { workData } = JSON.parse(localData);
                    const dataCount = Object.keys(workData || {}).length;
                    if (dataCount > 0) {
                        document.getElementById('migrationSection').style.display = 'block';
                        document.querySelector('.migration-section p').textContent = 
                            `ë¡œì»¬ì— ì €ì¥ëœ ${dataCount}ê±´ì˜ ê³µìˆ˜ ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œë¡œ ì´ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    }
                } catch (error) {
                    console.error('ë¡œì»¬ ë°ì´í„° í™•ì¸ ì˜¤ë¥˜:', error);
                }
            }
        }
        
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // í¼ ì „í™˜
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            
            if (tabName === 'signin') {
                document.getElementById('signinForm').classList.add('active');
            } else {
                document.getElementById('signupForm').classList.add('active');
            }
            
            // ë©”ì‹œì§€ ì´ˆê¸°í™”
            clearMessages();
        }
        
        // ë¡œê·¸ì¸ í¼ ì²˜ë¦¬
        document.getElementById('signinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            
            if (!email || !password) {
                showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            setLoading(true, 'signinButton', 'ë¡œê·¸ì¸ ì¤‘...');
            clearMessages();
            
            try {
                const { data, error } = await window.SupabaseClient.signIn(email, password);
                
                if (error) {
                    throw error;
                }
                
                showSuccess('ë¡œê·¸ì¸ ì„±ê³µ! ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                
                // ì ì‹œ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showError(getErrorMessage(error));
            } finally {
                setLoading(false, 'signinButton', 'ë¡œê·¸ì¸');
            }
        });
        
        // íšŒì›ê°€ì… í¼ ì²˜ë¦¬
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            
            if (!email || !password || !passwordConfirm) {
                showError('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            if (password !== passwordConfirm) {
                showError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (password.length < 6) {
                showError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            setLoading(true, 'signupButton', 'íšŒì›ê°€ì… ì¤‘...');
            clearMessages();
            
            try {
                const { data, error } = await window.SupabaseClient.signUp(email, password);
                
                if (error) {
                    throw error;
                }
                
                showSuccess('íšŒì›ê°€ì… ì„±ê³µ! ì´ë©”ì¼ì„ í™•ì¸í•˜ì—¬ ê³„ì •ì„ í™œì„±í™”í•˜ì„¸ìš”.');
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('signupForm').reset();
                
                // ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
                setTimeout(() => {
                    switchTab('signin');
                    document.querySelector('.login-tab').click();
                }, 2000);
                
            } catch (error) {
                console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
                showError(getErrorMessage(error));
            } finally {
                setLoading(false, 'signupButton', 'íšŒì›ê°€ì…');
            }
        });
        
        // ê²ŒìŠ¤íŠ¸ë¡œ ê³„ì†í•˜ê¸°
        function continueAsGuest() {
            // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
            localStorage.setItem('guestMode', 'true');
            window.location.href = 'index.html';
        }
        
        // ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
        async function migrateData() {
            if (isLoading) return;
            
            // ë¡œê·¸ì¸ í™•ì¸
            const { data } = await window.SupabaseClient.getCurrentUser();
            if (!data.user) {
                showError('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìœ„í•´ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                return;
            }
            
            setLoading(true, 'migrationButton', 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...');
            clearMessages();
            
            try {
                const success = await window.SupabaseClient.migrateLocalStorageToSupabase();
                
                if (success) {
                    showSuccess('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    document.getElementById('migrationSection').style.display = 'none';
                } else {
                    showError('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                setLoading(false, 'migrationButton', 'ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘');
            }
        }
        
        // ë¡œë”© ìƒíƒœ ì„¤ì •
        function setLoading(loading, buttonId, text) {
            isLoading = loading;
            const button = document.getElementById(buttonId);
            
            if (loading) {
                button.disabled = true;
                button.innerHTML = `<span class="loading"></span>${text}`;
            } else {
                button.disabled = false;
                button.innerHTML = text;
            }
        }
        
        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // ì„±ê³µ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('successMessage').style.display = 'none';
        }
        
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            // ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        // ë©”ì‹œì§€ ì´ˆê¸°í™”
        function clearMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        // ì—ëŸ¬ ë©”ì‹œì§€ ë³€í™˜
        function getErrorMessage(error) {
            const message = error.message || error.toString();
            
            // ì¼ë°˜ì ì¸ Supabase ì—ëŸ¬ ë©”ì‹œì§€ í•œêµ­ì–´ ë³€í™˜
            if (message.includes('Invalid login credentials')) {
                return 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            }
            if (message.includes('User already registered')) {
                return 'ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
            }
            if (message.includes('Password should be at least 6 characters')) {
                return 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
            }
            if (message.includes('Unable to validate email address')) {
                return 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.';
            }
            if (message.includes('Email not confirmed')) {
                return 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”.';
            }
            
            return message;
        }
    </script>
</body>
</html>